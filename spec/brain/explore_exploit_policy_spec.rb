require "spec"
require File.dirname(__FILE__) + "/../../src/brains/policy_based/policies/explore_exploit_policy"

describe ExploreExploitPolicy do

  before(:each) do
    @policy= ExploreExploitPolicy.new
    $GAME_INFO = {}
    $GAME_INFO[:action_info] = ""
  end

  it "should track average reward amount for each star" do

    reward = 10
    star_id = 1
    @policy.deliver_reward(reward, star_id)
    @policy.estimated_star_values[1].should == 10

    reward = 4
    star_id = 1
    @policy.deliver_reward(reward, star_id)
    @policy.estimated_star_values[1].should == 7

  end

  it "should exploit by moving towards highest valued star" do
    @policy.deliver_reward(1, 5)
    @policy.deliver_reward(2, 10)  
    environment_data = {:star_position_hash => {1 => Position.new(10,0), 2 => Position.new(0,10)}, :ship_position => Position.new(0,0)}
    @policy.current_strategy = :exploitation
    velocity = @policy.calc_velocity(environment_data)
    velocity.x.should == 0
    velocity.y.should == 10
  end

  it "should explore by moving towards a star that is not the highest valued star" do
    @policy.deliver_reward(1, 5)
    @policy.deliver_reward(2, 10)
    environment_data = {:star_position_hash => {1 => Position.new(10,0), 2 => Position.new(0,10)}, :ship_position => Position.new(0,0)}
    @policy.current_strategy = :exploration
    velocity = @policy.calc_velocity(environment_data)
    velocity.x.should == 10
    velocity.y.should == 0
  end

  it "should adjust explore/exploit strategy after receiving each reward, based on the exploration threshold" do
    @policy.exploration_threshold = 1 # this will ensure that the strategy switces to exploration as soon as given a chance.
    @policy.current_strategy = :exploitation
    @policy.deliver_reward(1,10)
    @policy.current_strategy.should == :exploration
    @policy.exploration_threshold = 0
    @policy.deliver_reward(1,10)
    @policy.current_strategy.should == :exploitation
  end

end